<div class="page-header">
  <h1> Project Board </h1>
</div>
Team Members :
<% @project.teams.each do |team| %>
  <% if team.user.present? %>
    <%= team.user.name %>
  <% end %>
<%end%>
<div>
  <%= link_to "List Backlog", project_workflow_path( @project.id, backlog_workflow(@project).id ) %>
  <%= link_to "List Closed", project_workflow_path(@project.id, closed_workflow(@project).id ) %>
</div>
<div class="lists_wrapper">
  <div class="lists_inner_wrapper">
    <section class="lists ui-sortable" id='section-block'>
      <% @project.workflows.each do |work_flow| %>
        <div id="list_9" class="list">
          <div class="issue_button">
            <span><%= work_flow.name %></span>
            <%= link_to "Add Issue", new_project_workflow_issue_path( @project, work_flow.id ), class: 'pull-right btn btn-primary'%>
          </div>
          <ul id=<%= "work_flow_"+work_flow.id.to_s %> class="connectedSortable issues_ul" >
            <li class="card default_card"></li>
            <% work_flow.issues.each do |issue| %>
              <li class="card ui-state-default" id= '<%= issue.id %>' > <%= issue.title %></li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </section>
  </div>
</div>

<script type="text/javascript">
    $(function() {
        $("#section-block").sortable().disableSelection();
        $("ul.connectedSortable").sortable({
            connectWith: ".connectedSortable",
            update: function(event, ui) {
              var issues_positions = $('.connectedSortable').serial();
              var params = {}
              params["work_flows"] = issues_positions
              $.ajax({
                url: '/issues/sort',
                data: params,
                type: "post"
                }).done(function() {
                console.log("success");
              });

            }
        }).disableSelection();
    });

    (function($) {
      $.fn.serial = function() {
        var workflows = {};
        var $elem = $(this);
        $elem.each(function(i) {
          var menu = this.id;
          var issues = {}
          $('li', this).each(function(e) {
            if(this.id)
              issues[e] = this.id
          });
          workflows[menu] = issues
        });
        return workflows;
      }
    })(jQuery);
</script>
